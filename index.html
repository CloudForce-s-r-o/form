<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8" />
    <title>Seznámení s dokumenty</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f5f5f5; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #bbb; background: #fff; }
        th { background: #e6e6e6; }
        .hidden { display: none; }
        button { margin-top: 20px; padding: 10px 18px; background: #0066cc; border: none; border-radius: 5px; color: white; cursor: pointer; }
        button:hover { background: #004c99; }
        #errorMsg { color: red; font-weight: bold; }
    </style>
</head>
<body>

<h1>Seznámení s dokumenty</h1>
<div id="errorMsg"></div>

<div id="loading">Načítám data…</div>

<div id="content" class="hidden">

    <button id="refreshBtn" onclick="refreshData()" class="hidden">Obnovit seznam</button>

    <h2>Dokumenty čekající na seznámení</h2>
    <table id="pendingTable">
        <thead>
            <tr>
                <th></th>
                <th>Název dokumentu</th>
                <th>Datum požadavku</th>
                <th>Odkaz</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Dokumenty již seznámené</h2>
    <table id="doneTable">
        <thead>
            <tr>
                <th>Název dokumentu</th>
                <th>Datum požadavku</th>
                <th>Datum seznámení</th>
                <th>Odkaz</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button id="confirmBtn" class="hidden">Potvrdit seznámení s dokumenty</button>
</div>

<script>
const USER_ID = new URLSearchParams(window.location.search).get("id");

// Endpointy
const verifyEndpoint = "https://default8da5bad552c84f89bb8a7500a8e0e2.53.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/11e51341bef74744be4c93cae776fcdf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xmsWpFTdq319G3NqcGgUNE7lWh8jICKymOlyyUxZdS4";
const submitEndpoint = "https://default8da5bad552c84f89bb8a7500a8e0e2.53.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1bb26896b1f2431bb7121fbda5e67851/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=O_cmrJd_YpxbBAlzQRmQpyGw2mTXKTdi-NX16NnT1VY";

// ----------------- NAČTENÍ DAT -----------------
async function loadData() {
    document.getElementById("errorMsg").innerHTML = "";
    document.getElementById("loading").classList.remove("hidden");

    try {
        const res = await fetch(verifyEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: USER_ID })
        });

        if (!res.ok) throw new Error("Chyba komunikace s API.");

        const data = await res.json();
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("content").classList.remove("hidden");
        document.getElementById("refreshBtn").classList.remove("hidden");

        renderTables(data);
    } catch (e) {
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("errorMsg").innerText = "Nepodařilo se načíst data: " + e.message;
    }
}

// ----------------- RENDER TABULEK -----------------
function renderTables(data) {
    const pendingTbody = document.querySelector("#pendingTable tbody");
    const doneTbody = document.querySelector("#doneTable tbody");
    pendingTbody.innerHTML = "";
    doneTbody.innerHTML = "";

    let hasPending = false;

    data.forEach(doc => {
        const row = document.createElement("tr");
        if (!doc.datumSeznameni) {
            hasPending = true;
            row.innerHTML = `
                <td><input type="checkbox" class="docCheck" value="${doc.id}"></td>
                <td>${doc.nazevSouboru}</td>
                <td>${doc.datumPozadavku}</td>
                <td><a href="${doc.odkazNaSoubor}" target="_blank">Otevřít dokument</a></td>
            `;
            pendingTbody.appendChild(row);
        } else {
            row.innerHTML = `
                <td>${doc.nazevSouboru}</td>
                <td>${doc.datumPozadavku}</td>
                <td>${doc.datumSeznameni}</td>
                <td><a href="${doc.odkazNaSoubor}" target="_blank">Otevřít dokument</a></td>
            `;
            doneTbody.appendChild(row);
        }
    });

    const btn = document.getElementById("confirmBtn");
    btn.classList.toggle("hidden", !hasPending);

    document.querySelectorAll(".docCheck").forEach(chk => {
        chk.addEventListener("change", () => {
            const anyChecked = document.querySelectorAll(".docCheck:checked").length > 0;
            btn.classList.toggle("hidden", !anyChecked);
        });
    });
}

// ----------------- ODESLAT POTVRZENÍ -----------------
document.getElementById("confirmBtn").addEventListener("click", async () => {
    const selectedIds = Array.from(document.querySelectorAll(".docCheck:checked")).map(c => c.value);
    if (selectedIds.length === 0) return;

    const payload = {
        id: USER_ID,
        timestamp: new Date().toISOString(),
        selectedDocs: selectedIds
    };

    try {
        const res = await fetch(submitEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert("Seznámení potvrzeno!");
            loadData(); // znovu načíst tabulky
        } else {
            alert("Chyba při odesílání.");
        }
    } catch (e) {
        alert("Chyba sítě: " + e.message);
    }
});

// ----------------- OBNOVIT SEZNAM -----------------
function refreshData() {
    loadData();
}

// ----------------- SPUŠTĚNÍ -----------------
loadData();
</script>

</body>
</html>
