<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8" />
    <title>Seznámení s dokumenty</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1, h2 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #bbb;
            background: #fff;
        }
        th {
            background: #e6e6e6;
        }
        .hidden {
            display: none;
        }
        button {
            margin-top: 20px;
            padding: 10px 18px;
            background: #0066cc;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #004c99;
        }
        #errorMsg {
            color: red;
            font-weight: bold;
        }
        #verifySection, #content {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

<h1>Seznámení s řízenou dokumentací</h1>

<div id="errorMsg"></div>

<!-- -------------------------------- -->
<!--          OVĚŘENÍ KÓDU            -->
<!-- -------------------------------- -->
<div id="verifySection">
    <h2>Ověření přístupu</h2>
    <p>Zadejte ověřovací kód:</p>
    <input id="accessCode" type="password" style="padding:8px; width:200px;" />
    <br><br>
    <button onclick="verifyCode()">Ověřit</button>
</div>

<div id="loading" class="hidden">Načítám data…</div>

<!-- -------------------------------- -->
<!--        HLAVNÍ OBSAH (DATA)       -->
<!-- -------------------------------- -->
<div id="content" class="hidden">

    <button id="refreshBtn" onclick="refreshData()" class="hidden">Obnovit seznam</button>

    <h2>Dokumenty čekající na seznámení</h2>
    <table id="pendingTable">
        <thead>
            <tr>
                <th></th>
                <th>Název dokumentu</th>
                <th>Datum požadavku</th>
                <th>Odkaz</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Dokumenty již seznámené</h2>
    <table id="doneTable">
        <thead>
            <tr>
                <th>Název dokumentu</th>
                <th>Datum požadavku</th>
                <th>Datum seznámení</th>
                <th>Odkaz</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button id="confirmBtn" class="hidden">Potvrdit seznámení s dokumenty</button>
</div>

<script>
// ---------------------------
// 1️⃣ ID z URL
// ---------------------------
function getIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id");
}
const USER_ID = getIdFromUrl();

if (!USER_ID) {
    document.getElementById("errorMsg").innerText = "Chybí parametr ?id= v URL!";
}

// ---------------------------
// 2️⃣ Ověření kódu
// ---------------------------
function verifyCode() {
    const code = document.getElementById("accessCode").value;

    if (!code) {
        document.getElementById("errorMsg").innerText = "Zadejte ověřovací kód.";
        return;
    }

    // pošleme jen uživatelské ID + kód
    loadData(code);
}

function refreshData() {
    loadData("NO_CODE_RECHECK_NEEDED");
}

// ---------------------------
// 3️⃣ Načtení dat z endpointu
// ---------------------------
async function loadData(codeValue) {
    document.getElementById("errorMsg").innerHTML = "";
    document.getElementById("loading").classList.remove("hidden");

    try {
        const res = await fetch("https://default8da5bad552c84f89bb8a7500a8e0e2.53.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/11e51341bef74744be4c93cae776fcdf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xmsWpFTdq319G3NqcGgUNE7lWh8jICKymOlyyUxZdS4", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id: USER_ID,
                code: codeValue
            })
        });

        if (!res.ok) {
            throw new Error("Chyba komunikace s API.");
        }

        const data = await res.json();

        // Hide code verification section
        document.getElementById("verifySection").classList.add("hidden");

        // Show refresh button
        document.getElementById("refreshBtn").classList.remove("hidden");

        renderTables(data);
    } catch (e) {
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("errorMsg").innerText =
            "Chybný kód nebo problém s API.";
    }
}

// ---------------------------
// 4️⃣ Vykreslení tabulek
// ---------------------------
function renderTables(data) {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("content").classList.remove("hidden");

    const pendingTbody = document.querySelector("#pendingTable tbody");
    const doneTbody = document.querySelector("#doneTable tbody");

    pendingTbody.innerHTML = "";
    doneTbody.innerHTML = "";

    let hasPending = false;

    data.forEach(doc => {
        const row = document.createElement("tr");

        // NESEZNÁMENÉ
        if (!doc.datumSeznameni) {
            hasPending = true;
            row.innerHTML = `
                <td><input type="checkbox" class="docCheck" value="${doc.id}"></td>
                <td>${doc.nazevSouboru}</td>
                <td>${doc.datumPozadavku}</td>
                <td><a href="${doc.odkazNaSoubor}" target="_blank">Otevřít dokument</a></td>
            `;
            pendingTbody.appendChild(row);

        // SEZNÁMENÉ
        } else {
            row.innerHTML = `
                <td>${doc.nazevSouboru}</td>
                <td>${doc.datumPozadavku}</td>
                <td>${doc.datumSeznameni}</td>
                <td><a href="${doc.odkazNaSoubor}" target="_blank">Otevřít dokument</a></td>
            `;
            doneTbody.appendChild(row);
        }
    });

    const btn = document.getElementById("confirmBtn");

    if (hasPending) {
        btn.classList.remove("hidden");
    } else {
        btn.classList.add("hidden");
    }

    // Aktivace dle checkboxů
    document.querySelectorAll(".docCheck").forEach(chk => {
        chk.addEventListener("change", () => {
            const anyChecked = document.querySelectorAll(".docCheck:checked").length > 0;
            if (anyChecked) btn.classList.remove("hidden");
            else if (!hasPending) btn.classList.add("hidden");
        });
    });
}

</script>
</body>
</html>
